<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Preview — Photo Sorter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .sample-thumb { height: 90px; object-fit: cover; border-radius: 6px; margin-right:8px }
      .group-card { min-height: 160px }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3 class="mb-0">Dry-run Preview</h3>
          <div class="text-muted">Source: <strong>{{ source }}</strong></div>
          <div class="text-muted">Destination: <strong>{{ dest or '(not set)' }}</strong></div>
        </div>
        <div class="text-end">
          <div class="h5">Total files</div>
          <div class="display-6">{{ total }}</div>
          <div class="mt-2">
            <button id="runAllConfirmBtn" class="btn btn-sm btn-success">Confirm and Run Copy (All)</button>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-3"><div class="card h-100"><div class="card-body"><div class="text-muted small">Input files</div><div class="fs-3">{{ total }}</div></div></div></div>
        <div class="col-md-3"><div class="card h-100"><div class="card-body"><div class="text-muted small">Planned copies</div><div class="fs-3">{{ accounted }}</div></div></div></div>
        <div class="col-md-3"><div class="card h-100"><div class="card-body"><div class="text-muted small">Duplicates (est.)</div><div class="fs-3 text-warning">0</div></div></div></div>
        <div class="col-md-3"><div class="card h-100"><div class="card-body"><div class="text-muted small">Failed/Issues (est.)</div><div class="fs-3 text-danger">{{ remaining }}</div></div></div></div>
      </div>

      <div class="card mb-3">
        <div class="card-body p-3">
          <h6 class="mb-2">Input vs Planned Output</h6>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead><tr><th>Metric</th><th>Count</th><th>Notes</th></tr></thead>
              <tbody>
                <tr><td>Total input files</td><td>{{ total }}</td><td>Discovered in source</td></tr>
                <tr><td>Planned copies</td><td>{{ accounted }}</td><td>Sum of all groups</td></tr>
                <tr><td>Duplicates (est.)</td><td>0</td><td>Computed during run</td></tr>
                <tr><td>Failed/Issues (est.)</td><td>{{ remaining }}</td><td>{% if remaining == 0 %}All accounted{% else %}Unaccounted in grouping{% endif %}</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="row g-3">
        {% for g in groups %}
        <div class="col-md-4">
          <div class="card group-card h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="card-title mb-0">{{ g.name }}</h6>
                <span class="badge bg-secondary">{{ g.count }}</span>
              </div>
              <div class="d-flex flex-wrap gap-2 mt-2">
                {% for s in g.samples %}
                  <div style="width:120px; height:90px; overflow:hidden; border-radius:6px; background:#fff; display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.06)">
                    <img style="max-width:100%; max-height:100%;" src="{{ s }}" alt="sample">
                  </div>
                {% endfor %}
              </div>
              <div class="mt-auto pt-3">
                <button class="btn btn-sm btn-primary run-folder-btn" data-group="{{ g.name }}">Confirm and Run Copy</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Progress Modal -->
      <div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Copy In Progress</h5>
            </div>
            <div class="modal-body">
              <div id="progressStatus" class="mb-2">Starting…</div>
              <div class="progress mb-2"><div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div></div>
              <div class="d-flex justify-content-between small text-muted"><span id="processedCount">0</span><span id="totalCount">/0</span></div>
              <div class="mt-2 small text-muted">
                <div>Group: <span id="currentGroup">-</span></div>
                <div>Current file: <span id="currentFile">-</span></div>
                <div>Copied: <span id="copiedCount">0</span> • Duplicates (skipped): <span id="duplicatesCount">0</span> • Failed: <span id="failedCount">0</span></div>
                <div>Start: <span id="startTime">-</span> • Finish: <span id="finishTime">-</span></div>
                <div>Speed: <span id="speedFps">-</span> files/sec • ETA: <span id="etaSeconds">-</span> sec</div>
                <div>Errors: <span id="errorsCount">0</span> <a href="#" id="showErrorsLink" style="display:none">(view)</a></div>
                <div id="errorsList" class="mt-2 small text-danger" style="display:none; max-height:120px; overflow:auto"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" id="downloadBtn" class="btn btn-outline-primary" style="display:none">Download Summary</button>
            </div>
          </div>
        </div>
      </div>

      <script>
        // Helper functions
        async function fetchJobJson(job) {
          const resp = await fetch(`/api/status?job=${job}`);
          if (!resp.ok) return null;
          return await resp.json();
        }
        function downloadJson(obj, name) {
          const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }

        // Handler for Run All button
        document.getElementById('runAllConfirmBtn').addEventListener('click', async () => {
          const source = '{{ source }}';
          const dest = '{{ dest }}';
          if (!confirm(`Start copying ALL groups ({{ total }} files)?`)) return;
          startJobModal({ source, dest });
        });

        // Attach handlers to folder run buttons
        document.querySelectorAll('.run-folder-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const group = btn.dataset.group;
            const source = '{{ source }}';
            const dest = '{{ dest }}';
            const count = btn.closest('.card').querySelector('.badge').innerText;
            if (!confirm(`Start copying ${group} (${count} files)?`)) return;
            startJobModal({ source, dest, group });
          });
        });

        // Shared function to start job and show modal
        async function startJobModal(params) {
          const resp = await fetch('/api/run_async', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
          if (!resp.ok) { alert('Error starting job'); return; }
          const data = await resp.json();
          const job = data.job;

          // Reset modal
          document.getElementById('progressStatus').textContent = 'Starting…';
          document.getElementById('processedCount').textContent = '0';
          document.getElementById('totalCount').textContent = '/0';
          document.getElementById('progressBar').style.width = '0%';
          document.getElementById('currentGroup').textContent = '-';
          document.getElementById('currentFile').textContent = '-';
          document.getElementById('copiedCount').textContent = '0';
          document.getElementById('duplicatesCount').textContent = '0';
          document.getElementById('failedCount').textContent = '0';
          document.getElementById('startTime').textContent = '-';
          document.getElementById('finishTime').textContent = '-';
          document.getElementById('speedFps').textContent = '-';
          document.getElementById('etaSeconds').textContent = '-';
          document.getElementById('errorsCount').textContent = '0';
          document.getElementById('showErrorsLink').style.display = 'none';
          document.getElementById('errorsList').style.display = 'none';
          document.getElementById('downloadBtn').style.display = 'none';

          // Show modal
          const pm = new bootstrap.Modal(document.getElementById('progressModal'));
          pm.show();

          // Poll status
          const poll = setInterval(async () => {
            const sresp = await fetch(`/api/status?job=${job}`);
            if (!sresp.ok) { console.warn('status error'); return; }
            const st = await sresp.json();
            // Update UI
            const total = st.total || 0;
            const processed = st.processed || 0;
            document.getElementById('processedCount').textContent = processed;
            document.getElementById('totalCount').textContent = '/' + total;
            const pct = total ? Math.round((processed/total)*100) : 0;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressStatus').textContent = `State: ${st.state}`;
            document.getElementById('currentGroup').textContent = st.current_group || st.currentGroup || '-';
            document.getElementById('currentFile').textContent = st.current_file_display || st.current_file || '-';
            document.getElementById('copiedCount').textContent = st.copied || 0;
            document.getElementById('duplicatesCount').textContent = st.duplicates || 0;
            document.getElementById('failedCount').textContent = st.failed || 0;
            document.getElementById('errorsCount').textContent = (st.errors || []).length;
            if (st.start_time) document.getElementById('startTime').textContent = new Date((st.start_time || 0) * 1000).toLocaleString();
            if (st.finished_time) document.getElementById('finishTime').textContent = new Date((st.finished_time || 0) * 1000).toLocaleString();
            document.getElementById('speedFps').textContent = st.speed_fps != null ? st.speed_fps : '-';
            document.getElementById('etaSeconds').textContent = st.eta_seconds != null ? st.eta_seconds : '-';
            const errs = st.errors || [];
            if (errs.length) {
              document.getElementById('showErrorsLink').style.display = 'inline';
              const el = document.getElementById('errorsList');
              el.innerHTML = errs.map(e => `<div>${e}</div>`).join('');
            } else {
              document.getElementById('showErrorsLink').style.display = 'none';
              document.getElementById('errorsList').style.display = 'none';
            }
            if (job && (st.state === 'running' || st.state === 'pending' || st.state === 'done')) {
              document.getElementById('downloadBtn').style.display = 'inline-block';
            }
            if (st.state === 'done' || st.state === 'error') {
              clearInterval(poll);
              document.getElementById('progressStatus').textContent = st.state === 'done' ? 'Completed' : ('Error: ' + (st.error||''));
              if (!st.finished_time) {
                document.getElementById('finishTime').textContent = new Date().toLocaleString();
              }
            }
          }, 1000);

          // Wire download button
          document.getElementById('downloadBtn').addEventListener('click', async () => {
            const data = await fetchJobJson(job);
            if (!data) { alert('Unable to fetch job JSON'); return; }
            downloadJson(data, `photo_sorter_job_${job}.json`);
          });
        }

        // Show/hide errors
        document.getElementById('showErrorsLink').addEventListener('click', (e) => {
          e.preventDefault();
          const el = document.getElementById('errorsList');
          if (el.style.display === 'none') {
            el.style.display = 'block';
            document.getElementById('showErrorsLink').textContent = '(hide)';
          } else {
            el.style.display = 'none';
            document.getElementById('showErrorsLink').textContent = '(view)';
          }
        });
      </script>

      <div class="mt-4">
        <a href="/" class="btn btn-link">Back</a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
